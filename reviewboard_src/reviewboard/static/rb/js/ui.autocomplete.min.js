(function(a){a.widget("ui.autocomplete",{_init:function(){a.extend(this.options,{delay:this.options.delay!=undefined?this.options.delay:(this.options.url?this.options.ajaxDelay:this.options.localDelay),max:this.options.max!=undefined?this.options.max:(this.options.scroll?this.options.scrollMax:this.options.noScrollMax),highlight:this.options.highlight||function(y){return y},formatMatch:this.options.formatMatch||this.options.formatItem});var l=this.element[0],k=this.options,c=a(l).attr("autocomplete","off").addClass(k.inputClass),b=a.ui.keyCode,v="",m=a.ui.autocomplete.cache(k),g=0,p={mouseDownOnSelect:false},f,w,t,u=a.ui.autocomplete.select(k,l,e,p);if(k.result){c.bind("result.autocomplete",k.result)}a.browser.opera&&a(l.form).bind("submit.autocomplete",function(){if(w){w=false;return false}});c.bind((a.browser.opera?"keypress":"keydown")+".autocomplete",function(y){t=y.keyCode;switch(y.keyCode){case b.UP:y.preventDefault();if(u.visible()){u.prev()}else{s(0,true)}break;case b.DOWN:y.preventDefault();if(u.visible()){u.next()}else{s(0,true)}break;case b.PAGE_UP:y.preventDefault();if(u.visible()){u.pageUp()}else{s(0,true)}break;case b.PAGE_DOWN:y.preventDefault();if(u.visible()){u.pageDown()}else{s(0,true)}break;case k.multiple&&a.trim(k.multipleSeparator)==","&&b.COMMA:case b.TAB:case b.ENTER:if(e()){y.preventDefault();w=true;return false}break;case b.ESCAPE:u.hide();break;default:clearTimeout(f);f=setTimeout(s,k.delay);break}}).focus(function(){g++}).blur(function(){g=0;if(!p.mouseDownOnSelect){r()}}).click(function(){if(g++>1&&!u.visible()){s(0,true)}}).bind("search",function(){var y=(arguments.length>1)?arguments[1]:null;function z(D,C){var B;if(C&&C.length){for(var A=0;A<C.length;A++){if(C[A].result.toLowerCase()==D.toLowerCase()){B=C[A];break}}}if(typeof y=="function"){y(B)}else{c.trigger("result",B&&[B.data,B.value])}}a.each(j(c.val()),function(A,B){i(B,z,z)})}).bind("flushCache",function(){m.flush()}).bind("setOptions",function(){a.extend(k,arguments[1]);if("data" in arguments[1]){m.populate()}}).bind("unautocomplete",function(){u.unbind();c.unbind();a(l.form).unbind(".autocomplete")});function e(){var z=u.selected();if(!z){return false}var y=z.result;v=y;if(k.multiple){var A=j(c.val());if(A.length>1){y=A.slice(0,A.length-1).join(k.multipleSeparator)+k.multipleSeparator+y}y+=k.multipleSeparator}c.val(y);q();c.trigger("result",[z.data,z.value]);return true}function s(A,z){if(t==a.ui.keyCode.DELETE){u.hide();return}var y=c.val();if(!z&&y==v){return}v=y;y=h(y);if(y.length>=k.minChars){c.addClass(k.loadingClass);if(!k.matchCase){y=y.toLowerCase()}i(y,d,q)}else{x();u.hide()}}function j(z){if(!z){return[""]}if(!k.multiple){return[z]}var A=z.split(k.multipleSeparator);var y=[];a.each(A,function(B,C){if(a.trim(C)){y[B]=a.trim(C)}});return y}function h(y){var z=j(y);return z[z.length-1]}function o(y,z){if(k.autoFill&&(h(c.val()).toLowerCase()==y.toLowerCase())&&t!=a.ui.keyCode.BACKSPACE){c.val(c.val()+z.substring(h(v).length));a.ui.autocomplete.selection(l,v.length,v.length+z.length)}}function r(){clearTimeout(f);f=setTimeout(q,200)}function q(){var y=u.visible();u.hide();clearTimeout(f);x();if(k.mustMatch){c.autocomplete("search",function(z){if(!z){if(k.multiple){var A=j(c.val()).slice(0,-1);c.val(A.join(k.multipleSeparator)+(A.length?k.multipleSeparator:""))}else{c.val("")}}})}if(y){a.ui.autocomplete.selection(l,l.value.length,l.value.length)}}function d(z,y){if(y&&y.length&&g){x();u.display(y,z);o(z,y[0].value);u.show()}else{q()}}function i(A,D,z){if(!k.matchCase){A=A.toLowerCase()}var C=m.load(A);if(C&&C.length){D(A,C)}else{if((typeof k.url=="string")&&(k.url.length>0)){var E={timestamp:+new Date()};a.each(k.extraParams,function(F,G){E[F]=typeof G=="function"?G(A):G});a.ajax({mode:"abort",port:"autocomplete"+l.name,dataType:k.dataType,url:k.url,data:a.extend({q:h(A),limit:k.max},E),success:function(G){var F=k.parse&&k.parse(G)||n(G);m.add(A,F);D(A,F)}})}else{if(k.source&&typeof k.source=="function"){var y=k.source(A);var B=(k.parse)?k.parse(y):y;m.add(A,B);D(A,B)}else{u.emptyList();z(A)}}}}function n(B){var z=[];var A=B.split("\n");for(var y=0;y<A.length;y++){var C=a.trim(A[y]);if(C){C=C.split("|");z[z.length]={data:C,value:C[0],result:k.formatResult&&k.formatResult(C,C[0])||C[0]}}}return z}function x(){c.removeClass(k.loadingClass)}},_propagate:function(c,b){a.ui.plugin.call(this,c,[b,this.ui()]);return this.element.triggerHandler(c=="autocomplete"?c:"autocomplete"+c,[b,this.ui()],this.options[c])},ui:function(b){return{options:this.options,element:this.element}},result:function(b){return this.element.bind("result",b)},search:function(b){return this.element.trigger("search",[b])},flushCache:function(){return this.element.trigger("flushCache")},setData:function(b,c){return this.element.trigger("setOptions",[{key:c}])},destroy:function(){this.element.removeAttr("disabled").removeClass("ui-autocomplete-input");return this.element.trigger("unautocomplete")},enable:function(){this.element.removeAttr("disabled").removeClass("ui-autocomplete-disabled");this.disabled=false},disable:function(){this.element.attr("disabled",true).addClass("ui-autocomplete-disabled");this.disabled=true}});a.extend(a.ui.autocomplete,{defaults:{inputClass:"ui-autocomplete-input",resultsClass:"ui-autocomplete-results",loadingClass:"ui-autocomplete-loading",minChars:1,ajaxDelay:400,localDelay:10,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,scrollMax:150,noScrollMax:10,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(b){return b[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(c,b){return c.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180,clickToURL:false}});a.ui.autocomplete.cache=function(d){var f={};var c=0;function h(l,k){if(!d.matchCase){l=l.toLowerCase()}var j=l.indexOf(k);if(j==-1){return false}return j==0||d.matchContains}function g(j,i){if(c>d.cacheLength){b()}if(!f[j]){c++}f[j]=i}function e(){if(!d.data){return false}var j={},p=0;if(!d.url){d.cacheLength=1}j[""]=[];for(var l=0,k=d.data.length;l<k;l++){var o=d.data[l];o=(typeof o=="string")?[o]:o;var n=d.formatMatch(o,l+1,d.data.length);if(n===false){continue}var m=n.charAt(0).toLowerCase();if(!j[m]){j[m]=[]}var q={value:n,data:o,result:d.formatResult&&d.formatResult(o)||n};j[m].push(q);if(p++<d.max){j[""].push(q)}}a.each(j,function(r,s){d.cacheLength++;g(r,s)})}setTimeout(e,25);function b(){f={};c=0}return{flush:b,add:g,populate:e,load:function(n){if(!d.cacheLength||!c){return null}if(!d.url&&d.matchContains){var m=[];for(var j in f){if(j.length>0){var o=f[j];a.each(o,function(p,k){if(h(k.value,n)){m.push(k)}})}}return m}else{if(f[n]){return f[n]}else{if(d.matchSubset){for(var l=n.length-1;l>=d.minChars;l--){var o=f[n.substr(0,l)];if(o){var m=[];a.each(o,function(p,k){if(h(k.value,n)){m[m.length]=k}});return m}}}}}return null}}};a.ui.autocomplete.select=function(f,j,q,l){var i={ACTIVE:"ui-autocomplete-over"};var t,d=-1,r,m="",s=true,h,p;function o(){if(!s){return}h=a("<div/>").hide().addClass(f.resultsClass).css("position","absolute").appendTo(document.body);p=a("<ul/>").appendTo(h).mouseover(function(u){if(k(u).nodeName&&k(u).nodeName.toUpperCase()=="LI"){d=a("li",p).removeClass(i.ACTIVE).index(k(u));a(k(u)).addClass(i.ACTIVE)}}).click(function(u){a(k(u)).addClass(i.ACTIVE);q();j.focus();return false}).mousedown(function(){l.mouseDownOnSelect=true}).mouseup(function(){l.mouseDownOnSelect=false});if(f.width>0){h.css("width",f.width)}s=false}function k(v){var u=v.target;while(u&&u.tagName!="LI"){u=u.parentNode}if(!u){return[]}return u}function c(u){t.slice(d,d+1).removeClass(i.ACTIVE);e(u);var w=t.slice(d,d+1).addClass(i.ACTIVE);if(f.scroll){var v=0;t.slice(0,d).each(function(){v+=this.offsetHeight});if((v+w[0].offsetHeight-p.scrollTop())>p[0].clientHeight){p.scrollTop(v+w[0].offsetHeight-p.innerHeight())}else{if(v<p.scrollTop()){p.scrollTop(v)}}}}function e(u){d+=u;if(d<0){d=t.size()-1}else{if(d>=t.size()){d=0}}}function b(u){return f.max&&f.max<u?f.max:u}function n(u){if(f.clickToURL===false){return a("<li/>")}else{return a("<li/>").click(function(){window.open(u.url)})}}function g(){p.empty();var v=b(r.length);for(var w=0;w<v;w++){if(!r[w]){continue}var x=f.formatItem(r[w].data,w+1,v,r[w].value,m);if(x===false){continue}var u=n(r[w].data).html(f.highlight(x,m)).addClass(w%2==0?"ui-autocomplete-even":"ui-autocomplete-odd").appendTo(p)[0];a.data(u,"ui-autocomplete-data",r[w])}t=p.find("li");if(f.selectFirst){t.slice(0,1).addClass(i.ACTIVE);d=0}if(a.fn.bgiframe){p.bgiframe()}}return{display:function(v,u){o();r=v;m=u;g()},next:function(){c(1)},prev:function(){c(-1)},pageUp:function(){if(d!=0&&d-8<0){c(-d)}else{c(-8)}},pageDown:function(){if(d!=t.size()-1&&d+8>t.size()){c(t.size()-1-d)}else{c(8)}},hide:function(){h&&h.hide();t&&t.removeClass(i.ACTIVE);d=-1;a(j).triggerHandler("autocompletehide",[{},{options:f}],f.hide)},visible:function(){return h&&h.is(":visible")},current:function(){return this.visible()&&(t.filter("."+i.ACTIVE)[0]||f.selectFirst&&t[0])},show:function(){var z=a(j).offset();var y=a(j).width();var x=typeof f.width=="string"||f.width>0?f.width:y;var v=a(window).width();h.css({width:x,top:z.top+j.offsetHeight,left:(x+z.left>v?z.left+y-x:z.left)}).show();if(f.scroll){p.scrollTop(0);p.css({maxHeight:f.scrollHeight,overflow:"auto"});if(a.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var u=0;t.each(function(){u+=this.offsetHeight});var w=u>f.scrollHeight;p.css("height",w?f.scrollHeight:u);if(!w){t.width(p.width()-parseInt(t.css("padding-left"))-parseInt(t.css("padding-right")))}}}a(j).triggerHandler("autocompleteshow",[{},{options:f}],f.show)},selected:function(){var u=t&&t.filter("."+i.ACTIVE).removeClass(i.ACTIVE);return u&&u.length&&a.data(u[0],"ui-autocomplete-data")},emptyList:function(){p&&p.empty()},unbind:function(){h&&h.remove()}}};a.ui.autocomplete.selection=function(d,e,c){if(d.createTextRange){var b=d.createTextRange();b.collapse(true);b.moveStart("character",e);b.moveEnd("character",c);b.select()}else{if(d.setSelectionRange){d.setSelectionRange(e,c)}else{if(d.selectionStart){d.selectionStart=e;d.selectionEnd=c}}}d.focus()}})(jQuery);